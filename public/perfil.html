<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - MiTienda503</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #e63946;
      --primary-dark: #c1121f;
      --secondary: #1d3557;
      --white: #ffffff;
      --gray-light: #f1f5f9;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.6;
      background-color: var(--gray-light);
      margin: 0;
      padding: 0;
    }

    .profile-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 30px;
    }

    .profile-sidebar {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 30px;
      height: fit-content;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      margin: 0 auto 20px;
    }

    .profile-name {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 30px;
      color: var(--secondary);
    }

    .profile-menu {
      list-style: none;
      padding: 0;
    }

    .profile-menu li {
      margin-bottom: 15px;
    }

    .profile-menu a {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #555;
      text-decoration: none;
      padding: 10px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .profile-menu a:hover, .profile-menu a.active {
      background-color: #f0f7ff;
      color: var(--primary);
    }

    .profile-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .profile-section {
      display: none;
    }

    .profile-section.active {
      display: block;
    }

    .section-title {
      font-size: 1.8rem;
      color: var(--secondary);
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .info-item {
      margin-bottom: 15px;
    }

    .info-label {
      font-weight: 500;
      color: #7f8c8d;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .info-value {
      font-size: 1.1rem;
      color: #2c3e50;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      min-height: 45px;
    }

    @media (max-width: 768px) {
      .profile-container {
        grid-template-columns: 1fr;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <aside class="profile-sidebar">
      <div class="profile-avatar" id="user-avatar">
        <i class="fas fa-user"></i>
      </div>
      <h2 class="profile-name" id="user-name">Cargando...</h2>
      <ul class="profile-menu">
        <li><a href="#" class="active" data-section="info"><i class="fas fa-user"></i> Información Personal</a></li>
        <li><a href="#" data-section="address"><i class="fas fa-map-marker-alt"></i> Dirección</a></li>
        <li><a href="#" data-section="orders"><i class="fas fa-shopping-bag"></i> Mis Compras</a></li>
        <li><a href="#" data-section="security"><i class="fas fa-lock"></i> Seguridad</a></li>
      </ul>
    </aside>

    <div class="profile-content">
      <section id="info-section" class="profile-section active">
        <h2 class="section-title"><i class="fas fa-user"></i> Información Personal</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Nombre completo</div>
            <div class="info-value" id="userFullName">Cargando...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Correo electrónico</div>
            <div class="info-value" id="userEmail">Cargando...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Teléfono</div>
            <div class="info-value" id="userPhone">Cargando...</div>
          </div>
        </div>
      </section>

      <section id="address-section" class="profile-section">
        <h2 class="section-title"><i class="fas fa-map-marker-alt"></i> Dirección</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Departamento</div>
            <div class="info-value" id="userDepartment">Cargando...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Municipio</div>
            <div class="info-value" id="userMunicipality">Cargando...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Dirección exacta</div>
            <div class="info-value" id="userAddress">Cargando...</div>
          </div>
        </div>
      </section>

      <section id="orders-section" class="profile-section">
        <h2 class="section-title"><i class="fas fa-shopping-bag"></i> Mis Compras</h2>
        <div id="ordersList">
          <p>Cargando historial de compras...</p>
        </div>
      </section>

      <section id="security-section" class="profile-section">
        <h2 class="section-title"><i class="fas fa-lock"></i> Seguridad</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Último inicio de sesión</div>
            <div class="info-value" id="lastLogin">Cargando...</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCR-axayENUg4FFb4jj0uVW2BnfwQ5EiXY",
      authDomain: "mitienda-c2609.firebaseapp.com",
      projectId: "mitienda-c2609",
      storageBucket: "mitienda-c2609.appspot.com",
      messagingSenderId: "536746062790",
      appId: "1:536746062790:web:cd39eb0057aac14c6538c7"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Cargar datos del usuario
    function loadUserData() {
      const user = auth.currentUser;
      
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      // Mostrar email inmediatamente
      document.getElementById('userEmail').textContent = user.email;
      
      // Obtener datos adicionales de Firestore
      db.collection("users").doc(user.uid).get().then((doc) => {
        if (doc.exists) {
          const userData = doc.data();
          
          // Mostrar nombre (prioridad: Firestore > Auth > email)
          const userName = userData.nombre || user.displayName || user.email.split('@')[0];
          document.getElementById('user-name').textContent = userName;
          document.getElementById('userFullName').textContent = userName;
          
          // Mostrar teléfono
          document.getElementById('userPhone').textContent = userData.telefono || "No especificado";
          
          // Mostrar dirección
          if (userData.direccion) {
            document.getElementById('userDepartment').textContent = userData.direccion.departamento || "No especificado";
            document.getElementById('userMunicipality').textContent = userData.direccion.municipio || "No especificado";
            document.getElementById('userAddress').textContent = userData.direccion.direccionExacta || "No especificado";
          }
          
          // Mostrar último login
          if (userData.lastLogin) {
            document.getElementById('lastLogin').textContent = userData.lastLogin.toDate().toLocaleString();
          } else {
            document.getElementById('lastLogin').textContent = "No disponible";
          }
          
          // Configurar avatar
          setupUserAvatar(user, userData);
        } else {
          // Si no hay datos en Firestore, usar solo datos de Auth
          const userName = user.displayName || user.email.split('@')[0];
          document.getElementById('user-name').textContent = userName;
          document.getElementById('userFullName').textContent = userName;
          document.getElementById('userPhone').textContent = "No especificado";
          setupUserAvatar(user);
        }
      }).catch((error) => {
        console.error("Error cargando datos:", error);
      });

      // Cargar historial de compras
      loadOrderHistory(user.uid);
    }

    // Configurar avatar del usuario
    function setupUserAvatar(user, userData = {}) {
      const avatar = document.getElementById('user-avatar');
      avatar.innerHTML = '';
      
      // Prioridad: photoURL de Auth > photoURL de Firestore > iniciales
      if (user.photoURL) {
        const img = document.createElement('img');
        img.src = user.photoURL;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.borderRadius = '50%';
        img.style.objectFit = 'cover';
        avatar.appendChild(img);
      } else if (userData.photoURL) {
        const img = document.createElement('img');
        img.src = userData.photoURL;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.borderRadius = '50%';
        img.style.objectFit = 'cover';
        avatar.appendChild(img);
      } else {
        const name = user.displayName || userData.nombre || user.email;
        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
        avatar.textContent = initials;
        avatar.style.display = 'flex';
        avatar.style.alignItems = 'center';
        avatar.style.justifyContent = 'center';
        avatar.style.fontSize = '2.5rem';
        avatar.style.fontWeight = 'bold';
      }
    }

    // Cargar historial de compras
    function loadOrderHistory(userId) {
      db.collection("orders")
        .where("userId", "==", userId)
        .orderBy("date", "desc")
        .get()
        .then((querySnapshot) => {
          const ordersList = document.getElementById('ordersList');
          
          if (querySnapshot.empty) {
            ordersList.innerHTML = `
              <div style="text-align: center; padding: 40px;">
                <i class="fas fa-shopping-bag" style="font-size: 3rem; color: #ddd;"></i>
                <p style="margin-top: 20px;">No has realizado ninguna compra aún</p>
              </div>
            `;
            return;
          }

          let ordersHTML = '';
          querySnapshot.forEach((doc) => {
            const order = doc.data();
            const orderDate = order.date.toDate().toLocaleDateString();
            
            ordersHTML += `
              <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <strong>Orden #${doc.id.substring(0, 8)}</strong>
                  <span>${orderDate}</span>
                </div>
                <div style="margin-bottom: 10px;">
                  ${order.items.map(item => `
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                      <img src="${item.image || 'https://via.placeholder.com/50'}" 
                           alt="${item.name}" 
                           style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                      <div>
                        <div>${item.name}</div>
                        <div style="color: var(--primary); font-weight: bold;">$${item.price} x ${item.quantity}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
                <div style="text-align: right; font-weight: bold;">
                  Total: $${order.total}
                </div>
                <div style="margin-top: 10px;">
                  <span style="background-color: ${getStatusColor(order.status)}; 
                               color: white; 
                               padding: 3px 8px; 
                               border-radius: 12px; 
                               font-size: 0.8rem;">
                    ${order.status}
                  </span>
                </div>
              </div>
            `;
          });

          ordersList.innerHTML = ordersHTML;
        })
        .catch((error) => {
          console.error("Error cargando compras:", error);
          document.getElementById('ordersList').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--primary);">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i>
              <p style="margin-top: 15px;">Error al cargar el historial de compras</p>
            </div>
          `;
        });
    }

    // Helper para colores de estado
    function getStatusColor(status) {
      switch(status.toLowerCase()) {
        case 'completado': return '#28a745';
        case 'pendiente': return '#ffc107';
        case 'cancelado': return '#dc3545';
        default: return '#6c757d';
      }
    }

    // Manejar cambio de secciones
    document.querySelectorAll('.profile-menu a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remover clase active de todos
        document.querySelectorAll('.profile-menu a').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelectorAll('.profile-section').forEach(section => {
          section.classList.remove('active');
        });
        
        // Agregar clase active al seleccionado
        this.classList.add('active');
        const sectionId = this.getAttribute('data-section');
        document.getElementById(`${sectionId}-section`).classList.add('active');
      });
    });

    // Verificar autenticación al cargar
    auth.onAuthStateChanged((user) => {
      if (user) {
        loadUserData();
      } else {
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
