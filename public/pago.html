<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago - TecnoExpress</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }
    
    .order-summary, .payment-form {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 30px;
    }
    
    .order-summary h2, .payment-form h2 {
      font-size: 1.5rem;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .item-quantity {
      margin: 0 10px;
    }
    
    .order-total {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 2px solid #f0f0f0;
      text-align: right;
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .submit-payment {
      background-color: #27ae60;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    .submit-payment:hover {
      background-color: #219955;
      transform: translateY(-2px);
    }
    
    .error {
      color: #e74c3c;
      text-align: center;
      padding: 20px;
    }
    
    .error i {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .section-title {
      font-size: 1.2rem;
      color: #2c3e50;
      margin: 25px 0 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }

    /* Estilos mejorados para tarjetas */
    .card-icon-container {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }

    .card-icon {
      margin-right: 10px;
      font-size: 1.5rem;
      color: #555;
    }

    #cardNumber {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="12" viewBox="0 0 20 12"><path fill="%23999" d="M4 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm1 0a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm8 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm1 0a2 2 0 1 1-4 0 2 2 0 0 1 4 0zM3 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm9-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm1 0a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px;
    }

    /* Validación visual */
    input:invalid, select:invalid {
      border-color: #e74c3c;
    }

    input:valid, select:valid {
      border-color: #2ecc71;
    }

    .error-message {
      color: #e74c3c;
      font-size: 0.8rem;
      margin-top: 5px;
      display: none;
    }

    input:invalid + .error-message,
    select:invalid + .error-message {
      display: block;
    }
    
    @media (max-width: 768px) {
      .checkout-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-container">
      <div class="logo">
        <a href="index.html"><img src="img/logo.png" alt="TecnoExpress"></a>
      </div>
      <nav>
        <ul>
          <li><a href="index.html"><i class="fas fa-home"></i> Inicio</a></li>
          <li><a href="productos.html"><i class="fas fa-print"></i> Productos</a></li>
          <li><a href="#"><i class="fas fa-envelope"></i> Contacto</a></li>
        </ul>
      </nav>
      <div class="cart-icon" id="cartIcon">
        <i class="fas fa-shopping-cart"></i>
        <span id="cartCounter">0</span>
      </div>
    </div>
  </header>

  <main class="container">
    <h1><i class="fas fa-credit-card"></i> Finalizar Compra</h1>
    
    <div class="checkout-grid">
      <div class="order-summary">
        <h2>Resumen de tu Pedido</h2>
        <div id="orderItems"></div>
        <div class="order-total">
          Total: $<span id="orderTotal">0.00</span>
        </div>
      </div>
      
      <div class="payment-form">
        <h2>Información de Envío y Pago</h2>
        <form id="paymentForm">
          <!-- Sección de Información de Contacto -->
          <div class="section-title">Información de Contacto</div>
          <div id="guestFields">
            <div class="form-group">
              <label for="customerEmail">Correo Electrónico</label>
              <input type="email" id="customerEmail" required>
              <div class="error-message">Por favor ingrese un correo válido</div>
            </div>
            <div class="form-group">
              <label for="customerPhone">Teléfono</label>
              <input type="tel" id="customerPhone" required>
              <div class="error-message">Por favor ingrese un teléfono válido</div>
            </div>
          </div>
          
          <!-- Sección de Dirección de Envío -->
          <div class="section-title">Dirección de Envío</div>
          <div class="form-group">
            <label for="shippingAddress">Dirección</label>
            <input type="text" id="shippingAddress" placeholder="Calle y número" required>
            <div class="error-message">Por favor ingrese su dirección</div>
          </div>
          
          <div class="form-group">
            <label for="shippingAddress2">Detalles adicionales (opcional)</label>
            <input type="text" id="shippingAddress2" placeholder="Apartamento, suite, etc.">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="departamento">Departamento</label>
              <select id="departamento" name="departamento" required>
                <option value="">Seleccione un departamento</option>
              </select>
              <div class="error-message">Por favor seleccione un departamento</div>
            </div>
            
            <div class="form-group">
              <label for="municipio">Municipio</label>
              <select id="municipio" name="municipio" required disabled>
                <option value="">Primero seleccione un departamento</option>
              </select>
              <div class="error-message">Por favor seleccione un municipio</div>
            </div>
          </div>
            
          <!-- Sección de Método de Pago -->
          <div class="section-title">Método de Pago</div>
          <div class="form-group">
            <label for="cardName">Nombre en la Tarjeta</label>
            <input type="text" id="cardName" required>
            <div class="error-message">Por favor ingrese el nombre en la tarjeta</div>
          </div>
          
          <div class="form-group">
            <label for="cardNumber">Número de Tarjeta</label>
            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required pattern="[0-9\s]{13,19}">
            <div class="error-message">Por favor ingrese un número de tarjeta válido</div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="expiryDate">Fecha de Expiración</label>
              <input type="text" id="expiryDate" placeholder="MM/AA" required pattern="(0[1-9]|1[0-2])\/?([0-9]{2})">
              <div class="error-message">Formato MM/AA</div>
            </div>
            
            <div class="form-group">
              <label for="cvv">CVV</label>
              <input type="text" id="cvv" placeholder="123" required pattern="\d{3,4}">
              <div class="error-message">Código de seguridad inválido</div>
            </div>
          </div>
          
          <button type="submit" class="submit-payment">
            <i class="fas fa-lock"></i> Pagar $<span id="paymentTotal">0.00</span>
          </button>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, serverTimestamp, 
      doc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
    import { AuthService } from '/js/auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCR-axayENUg4FFb4jj0uVW2BnfwQ5EiXY",
      authDomain: "mitienda-c2609.firebaseapp.com",
      databaseURL: "https://mitienda-c2609-default-rtdb.firebaseio.com",
      projectId: "mitienda-c2609",
      storageBucket: "mitienda-c2609.appspot.com",
      messagingSenderId: "536746062790",
      appId: "1:536746062790:web:cd39eb0057aac14c6538c7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Datos de departamentos y municipios de El Salvador
    const departamentos = {
      "Ahuachapán": ["Ahuachapán", "Atiquizaya", "Concepción de Ataco", "El Refugio", "Guaymango", "Jujutla", "San Francisco Menéndez", "San Lorenzo", "San Pedro Puxtla", "Tacuba", "Turín"],
      "Cabañas": ["Sensuntepeque", "Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Tejutepeque", "Victoria"],
      "Chalatenango": ["Chalatenango", "Agua Caliente", "Arcatao", "Azacualpa", "Cancasque", "Citalá", "Comalapa", "Concepción Quezaltepeque", "Dulce Nombre de María", "El Carrizal", "El Paraíso", "La Laguna", "La Palma", "La Reina", "Las Vueltas", "Nombre de Jesús", "Nueva Concepción", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco Morazán", "San Ignacio", "San Isidro Labrador", "San José Cancasque", "San José Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],
      "Cuscatlán": ["Cojutepeque", "Candelaria", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de Concepción", "San Bartolomé Perulapía", "San Cristóbal", "San José Guayabal", "San Pedro Perulapán", "San Rafael Cedros", "San Ramón", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo"],
      "La Libertad": ["Santa Tecla", "Antiguo Cuscatlán", "Chiltiupán", "Ciudad Arce", "Colón", "Comasagua", "Huizúcar", "Jayaque", "Jicalapa", "La Libertad", "Nuevo Cuscatlán", "Opico", "Quezaltepeque", "Sacacoyo", "San José Villanueva", "San Juan Opico", "San Matías", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],
      "La Paz": ["Zacatecoluca", "Cuyultitán", "El Rosario", "Jerusalén", "Mercedes La Ceiba", "Olocuilta", "Paraíso de Osorio", "San Antonio Masahuat", "San Emigdio", "San Francisco Chinameca", "San Juan Nonualco", "San Juan Talpa", "San Juan Tepezontes", "San Luis La Herradura", "San Luis Talpa", "San Miguel Tepezontes", "San Pedro Masahuat", "San Pedro Nonualco", "San Rafael Obrajuelo", "Santa María Ostuma", "Santiago Nonualco", "Tapalhuaca"],
      "La Unión": ["La Unión", "Anamorós", "Bolívar", "Concepción de Oriente", "Conchagua", "El Carmen", "El Sauce", "Intipucá", "Lislique", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "Polorós", "San Alejo", "San José", "Santa Rosa de Lima", "Yayantique", "Yucuaiquín"],
      "Morazán": ["San Francisco Gotera", "Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de Concepción", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Lolotiquillo", "Meanguera", "Osicala", "Perquín", "San Carlos", "San Fernando", "San Isidro", "San Simón", "Sensembra", "Sociedad", "Torola", "Yamabal", "Yoloaiquín"],
      "San Miguel": ["San Miguel", "Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "Comacarán", "El Tránsito", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo Edén de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Rafael Oriente", "Sesori", "Uluazapa"],
      "San Salvador": ["San Salvador", "Aguilares", "Apopa", "Ayutuxtepeque", "Cuscatancingo", "Delgado", "El Paisnal", "Guazapa", "Ilopango", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San Martín", "Santiago Texacuangos", "Santo Tomás", "Soyapango", "Tonacatepeque"],
      "San Vicente": ["San Vicente", "Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San Sebastián", "Santa Clara", "Santo Domingo", "Tecoluca", "Tepetitán", "Verapaz"],
      "Santa Ana": ["Santa Ana", "Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "Masahuat", "Metapán", "San Antonio Pajonal", "San Sebastián Salitrillo", "Santa Rosa Guachipilín", "Santiago de la Frontera", "Texistepeque"],
      "Sonsonate": ["Sonsonate", "Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "Juayúa", "Nahuizalco", "Nahulingo", "Salcoatitán", "San Antonio del Monte", "San Julián", "Santa Catarina Masahuat", "Santa Isabel Ishuatán", "Santo Domingo de Guzmán", "Sonzacate"],
      "Usulután": ["Usulután", "Alegría", "Berlín", "California", "Concepción Batres", "El Triunfo", "Ereguayquín", "Estanzuelas", "Jiquilisco", "Jucuapa", "Jucuarán", "Mercedes Umaña", "Nueva Granada", "Ozatlán", "Puerto El Triunfo", "San Agustín", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa María", "Santiago de María", "Tecapán"]
    };

    // Llenar select de departamentos
    const deptoSelect = document.getElementById('departamento');
    const muniSelect = document.getElementById('municipio');

    Object.keys(departamentos).forEach(depto => {
      const option = document.createElement('option');
      option.value = depto;
      option.textContent = depto;
      deptoSelect.appendChild(option);
    });

    // Manejar cambio de departamento
    deptoSelect.addEventListener('change', function() {
      muniSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
      muniSelect.disabled = !this.value;
      
      if (this.value) {
        departamentos[this.value].forEach(muni => {
          const option = document.createElement('option');
          option.value = muni;
          option.textContent = muni;
          muniSelect.appendChild(option);
        });
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const user = await AuthService.checkAuth();
        const checkoutData = 
          JSON.parse(localStorage.getItem('checkoutData')) || 
          JSON.parse(sessionStorage.getItem('tempCheckout')) || 
          { items: [], total: 0 };

        // Si hay usuario autenticado, prellenar campos de contacto
        if (user) {
          document.getElementById('customerEmail').value = user.email;
          document.getElementById('customerEmail').readOnly = true;
          
          // Obtener datos adicionales del usuario si existen
          try {
            const userProfile = await AuthService.getUserProfile(user.uid);
            if (userProfile) {
              if (userProfile.phone) {
                document.getElementById('customerPhone').value = userProfile.phone;
              }
              if (userProfile.address) {
                document.getElementById('shippingAddress').value = userProfile.address;
              }
            }
          } catch (error) {
            console.error("Error al obtener perfil:", error);
          }
        }

        if (!checkoutData.items || checkoutData.items.length === 0) {
          document.getElementById('orderItems').innerHTML = `
            <div class="error">
              <i class="fas fa-exclamation-triangle"></i>
              <p>No se encontraron productos. Redirigiendo...</p>
            </div>
          `;
          setTimeout(() => window.location.href = 'productos.html', 2000);
          return;
        }

        // Mostrar productos
        let html = '';
        checkoutData.items.forEach(item => {
          html += `
            <div class="order-item">
              <span>${item.name}</span>
              <span class="item-quantity">${item.quantity} ×</span>
              <span class="item-price">$${item.price.toFixed(2)}</span>
            </div>
          `;
        });
        document.getElementById('orderItems').innerHTML = html;

        // Mostrar totales
        const total = checkoutData.total.toFixed(2);
        document.getElementById('orderTotal').textContent = total;
        document.getElementById('paymentTotal').textContent = total;

        // Actualizar contador del carrito
        document.getElementById('cartCounter').textContent = 
          checkoutData.items.reduce((sum, item) => sum + item.quantity, 0);

        // Manejar pago
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          try {
            // Obtener datos de contacto
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();

            // Obtener datos de envío
            const shippingAddress1 = document.getElementById('shippingAddress').value.trim();
            const shippingAddress2 = document.getElementById('shippingAddress2').value.trim();
            const departamento = document.getElementById('departamento').value;
            const municipio = document.getElementById('municipio').value;

            // Validar datos de contacto
            if (!customerEmail || !customerPhone) {
              alert('Por favor complete todos los campos de contacto');
              return;
            }

            // Validar datos de envío
            if (!shippingAddress1 || !departamento || !municipio) {
              alert('Por favor complete todos los campos de dirección');
              return;
            }

            // Obtener datos de pago
            const cardName = document.getElementById('cardName').value.trim();
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expiryDate = document.getElementById('expiryDate').value.trim();
            const cvv = document.getElementById('cvv').value.trim();

            // Validar datos de pago
            if (!cardName || !cardNumber || !expiryDate || !cvv) {
              alert('Por favor complete todos los campos de pago');
              return;
            }

            // Crear dirección completa
            const fullAddress = `${shippingAddress1}${shippingAddress2 ? ', ' + shippingAddress2 : ''}, ${municipio}, ${departamento}`;

            // Crear objeto de orden
            const orderData = {
              userId: user ? user.uid : `guest_${Date.now()}`,
              items: checkoutData.items,
              subtotal: checkoutData.subtotal || checkoutData.total * 0.88,
              tax: checkoutData.tax || checkoutData.total * 0.12,
              total: checkoutData.total,
              customerInfo: {
                email: customerEmail,
                phone: customerPhone
              },
              shippingInfo: {
                address: fullAddress,
                departamento: departamento,
                municipio: municipio
              },
              paymentInfo: {
                method: 'Tarjeta de crédito',
                cardLastFour: cardNumber.slice(-4)
              },
              status: 'Procesando',
              date: serverTimestamp()
            };

            // Guardar la orden en Firestore
            const orderRef = await addDoc(collection(db, 'orders'), orderData);

            // Para usuarios registrados, actualizar su perfil con la nueva información
            if (user) {
              try {
                await updateDoc(doc(db, 'users', user.uid), {
                  phone: customerPhone,
                  address: fullAddress,
                  lastUpdated: serverTimestamp()
                });
              } catch (error) {
                console.error("Error al actualizar perfil:", error);
              }

              // Limpiar carrito en Firestore
              await setDoc(doc(db, 'carts', user.uid), {
                items: [],
                lastUpdated: serverTimestamp()
              });
            }

            // Limpiar datos temporales
            sessionStorage.setItem('clearCartOnLoad', 'true');
            localStorage.removeItem('cart');
            localStorage.removeItem('checkoutData');
            sessionStorage.removeItem('tempCheckout');

            // Mostrar confirmación y redirigir
            alert(`✅ Pedido #${orderRef.id.substring(0, 8)} completado.\nSe ha enviado un correo de confirmación a ${customerEmail}`);
            window.location.href = user ? 'perfil.html#compras' : 'index.html';
          } catch (error) {
            console.error("Error al procesar pago:", error);
            alert('Error al procesar el pago: ' + error.message);
          }
        });
      } catch (error) {
        console.error("Error:", error);
        alert('Error al cargar la página de pago: ' + error.message);
        window.location.href = 'productos.html';
      }
    });
  </script>
</body>
</html>
