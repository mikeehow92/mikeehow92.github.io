<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago - TecnoExpress</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }
    
    .order-summary, .payment-form {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 30px;
    }
    
    .order-summary h2, .payment-form h2 {
      font-size: 1.5rem;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .item-quantity {
      margin: 0 10px;
    }
    
    .order-total {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 2px solid #f0f0f0;
      text-align: right;
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .submit-payment {
      background-color: #27ae60;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    .submit-payment:hover {
      background-color: #219955;
      transform: translateY(-2px);
    }
    
    .error {
      color: #e74c3c;
      text-align: center;
      padding: 20px;
    }
    
    .error i {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .section-title {
      font-size: 1.2rem;
      color: #2c3e50;
      margin: 25px 0 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }

    /* Estilos para cuentas guest */
    .guest-field {
      display: none;
    }
    
    /* Estilos para tarjetas */
    .card-icon-container {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }

    .card-icon {
      margin-right: 10px;
      font-size: 1.5rem;
      color: #555;
    }

    #cardNumber {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="12" viewBox="0 0 20 12"><path fill="%23999" d="M4 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm1 0a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm8 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm1 0a2 2 0 1 1-4 0 2 2 0 0 1 4 0zM3 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm9-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm1 0a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px;
    }

    /* Validación visual */
    input:invalid, select:invalid {
      border-color: #e74c3c;
    }

    input:valid, select:valid {
      border-color: #2ecc71;
    }

    .error-message {
      color: #e74c3c;
      font-size: 0.8rem;
      margin-top: 5px;
      display: none;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.3);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-items {
      text-align: center;
      padding: 20px;
    }

    /* Estilos para feedback */
    .feedback-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .feedback-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .feedback-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    .feedback-icon {
      font-size: 3rem;
      margin-bottom: 20px;
    }
    
    .success { color: #27ae60; }
    .error { color: #e74c3c; }
    .warning { color: #f39c12; }

    @media (max-width: 768px) {
      .checkout-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-container">
      <div class="logo">
        <a href="index.html"><img src="img/logo.png" alt="TecnoExpress"></a>
      </div>
      <nav>
        <ul>
          <li><a href="index.html"><i class="fas fa-home"></i> Inicio</a></li>
          <li><a href="productos.html"><i class="fas fa-print"></i> Productos</a></li>
          <li><a href="#"><i class="fas fa-envelope"></i> Contacto</a></li>
        </ul>
      </nav>
      <div class="cart-icon" id="cartIcon">
        <i class="fas fa-shopping-cart"></i>
        <span id="cartCounter">0</span>
      </div>
    </div>
  </header>

  <main class="container">
    <h1><i class="fas fa-credit-card"></i> Finalizar Compra</h1>
    
    <div class="checkout-grid">
      <div class="order-summary">
        <h2>Resumen de tu Pedido</h2>
        <div id="orderItems">
          <div class="loading-items">
            <span class="loading"></span> Cargando productos...
          </div>
        </div>
        <div class="order-total">
          Total: $<span id="orderTotal">0.00</span>
        </div>
      </div>
      
      <div class="payment-form">
        <h2>Información de Envío y Pago</h2>
        <form id="paymentForm">
          <!-- Sección de Información de Contacto -->
          <div class="section-title">Información de Contacto</div>
          
          <!-- Campo para nombre completo en cuentas guest -->
          <div id="guestNameField" class="form-group guest-field">
            <label for="customerName">Nombre Completo</label>
            <input type="text" id="customerName">
            <div class="error-message">Por favor ingrese su nombre completo</div>
          </div>
          
          <div class="form-group">
            <label for="customerEmail">Correo Electrónico</label>
            <input type="email" id="customerEmail" required>
            <div class="error-message">Por favor ingrese un correo válido</div>
          </div>
          <div class="form-group">
            <label for="customerPhone">Teléfono</label>
            <input type="tel" id="customerPhone" required>
            <div class="error-message">Por favor ingrese un teléfono válido</div>
          </div>
          
          <!-- Sección de Dirección de Envío -->
          <div class="section-title">Dirección de Envío</div>
          <div class="form-group">
            <label for="shippingAddress">Dirección</label>
            <input type="text" id="shippingAddress" placeholder="Calle y número" required>
            <div class="error-message">Por favor ingrese su dirección</div>
          </div>
          
          <div class="form-group">
            <label for="shippingAddress2">Detalles adicionales (opcional)</label>
            <input type="text" id="shippingAddress2" placeholder="Apartamento, suite, etc.">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="departamento">Departamento</label>
              <select id="departamento" name="departamento" required>
                <option value="">Seleccione un departamento</option>
              </select>
              <div class="error-message">Por favor seleccione un departamento</div>
            </div>
            
            <div class="form-group">
              <label for="municipio">Municipio</label>
              <select id="municipio" name="municipio" required disabled>
                <option value="">Primero seleccione un departamento</option>
              </select>
              <div class="error-message">Por favor seleccione un municipio</div>
            </div>
          </div>
            
          <!-- Sección de Método de Pago -->
          <div class="section-title">Método de Pago</div>
          <div class="form-group">
            <label for="cardName">Nombre en la Tarjeta</label>
            <input type="text" id="cardName" required>
            <div class="error-message">Por favor ingrese el nombre en la tarjeta</div>
          </div>
          
          <div class="form-group">
            <label for="cardNumber">Número de Tarjeta</label>
            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required pattern="[0-9\s]{13,19}">
            <div class="error-message">Por favor ingrese un número de tarjeta válido</div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="expiryDate">Fecha de Expiración</label>
              <input type="text" id="expiryDate" placeholder="MM/AA" required pattern="(0[1-9]|1[0-2])\/?([0-9]{2})">
              <div class="error-message">Formato MM/AA</div>
            </div>
            
            <div class="form-group">
              <label for="cvv">CVV</label>
              <input type="text" id="cvv" placeholder="123" required pattern="\d{3,4}">
              <div class="error-message">Código de seguridad inválido</div>
            </div>
          </div>
          
          <button type="submit" class="submit-payment">
            <i class="fas fa-lock"></i> Pagar $<span id="paymentTotal">0.00</span>
          </button>
        </form>
      </div>
    </div>
  </main>

  <!-- Feedback Modal -->
  <div class="feedback-overlay" id="feedbackModal">
    <div class="feedback-content">
      <div class="feedback-icon" id="feedbackIcon">
        <i class="fas fa-check-circle success"></i>
      </div>
      <h3 id="feedbackTitle">¡Pago Completado!</h3>
      <p id="feedbackMessage">Tu pedido ha sido procesado correctamente.</p>
      <button class="submit-payment" id="feedbackClose">Aceptar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, serverTimestamp, 
      doc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
    import { AuthService } from '/js/auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCR-axayENUg4FFb4jj0uVW2BnfwQ5EiXY",
      authDomain: "mitienda-c2609.firebaseapp.com",
      databaseURL: "https://mitienda-c2609-default-rtdb.firebaseio.com",
      projectId: "mitienda-c2609",
      storageBucket: "mitienda-c2609.appspot.com",
      messagingSenderId: "536746062790",
      appId: "1:536746062790:web:cd39eb0057aac14c6538c7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Datos de departamentos y municipios de El Salvador
    const departamentos = {
      "Ahuachapán": ["Ahuachapán", "Atiquizaya", "Concepción de Ataco", "El Refugio", "Guaymango", "Jujutla", "San Francisco Menéndez", "San Lorenzo", "San Pedro Puxtla", "Tacuba", "Turín"],
      "Cabañas": ["Sensuntepeque", "Cinquera", "Dolores", "Guacotecti", "Ilobasco", "Jutiapa", "San Isidro", "Tejutepeque", "Victoria"],
      "Chalatenango": ["Chalatenango", "Agua Caliente", "Arcatao", "Azacualpa", "Cancasque", "Citalá", "Comalapa", "Concepción Quezaltepeque", "Dulce Nombre de María", "El Carrizal", "El Paraíso", "La Laguna", "La Palma", "La Reina", "Las Vueltas", "Nombre de Jesús", "Nueva Concepción", "Nueva Trinidad", "Ojos de Agua", "Potonico", "San Antonio de la Cruz", "San Antonio Los Ranchos", "San Fernando", "San Francisco Lempa", "San Francisco Morazán", "San Ignacio", "San Isidro Labrador", "San José Cancasque", "San José Las Flores", "San Luis del Carmen", "San Miguel de Mercedes", "San Rafael", "Santa Rita", "Tejutla"],
      "Cuscatlán": ["Cojutepeque", "Candelaria", "El Carmen", "El Rosario", "Monte San Juan", "Oratorio de Concepción", "San Bartolomé Perulapía", "San Cristóbal", "San José Guayabal", "San Pedro Perulapán", "San Rafael Cedros", "San Ramón", "Santa Cruz Analquito", "Santa Cruz Michapa", "Suchitoto", "Tenancingo"],
      "La Libertad": ["Santa Tecla", "Antiguo Cuscatlán", "Chiltiupán", "Ciudad Arce", "Colón", "Comasagua", "Huizúcar", "Jayaque", "Jicalapa", "La Libertad", "Nuevo Cuscatlán", "Opico", "Quezaltepeque", "Sacacoyo", "San José Villanueva", "San Juan Opico", "San Matías", "San Pablo Tacachico", "Talnique", "Tamanique", "Teotepeque", "Tepecoyo", "Zaragoza"],
      "La Paz": ["Zacatecoluca", "Cuyultitán", "El Rosario", "Jerusalén", "Mercedes La Ceiba", "Olocuilta", "Paraíso de Osorio", "San Antonio Masahuat", "San Emigdio", "San Francisco Chinameca", "San Juan Nonualco", "San Juan Talpa", "San Juan Tepezontes", "San Luis La Herradura", "San Luis Talpa", "San Miguel Tepezontes", "San Pedro Masahuat", "San Pedro Nonualco", "San Rafael Obrajuelo", "Santa María Ostuma", "Santiago Nonualco", "Tapalhuaca"],
      "La Unión": ["La Unión", "Anamorós", "Bolívar", "Concepción de Oriente", "Conchagua", "El Carmen", "El Sauce", "Intipucá", "Lislique", "Meanguera del Golfo", "Nueva Esparta", "Pasaquina", "Polorós", "San Alejo", "San José", "Santa Rosa de Lima", "Yayantique", "Yucuaiquín"],
      "Morazán": ["San Francisco Gotera", "Arambala", "Cacaopera", "Chilanga", "Corinto", "Delicias de Concepción", "El Divisadero", "El Rosario", "Gualococti", "Guatajiagua", "Joateca", "Jocoaitique", "Jocoro", "Lolotiquillo", "Meanguera", "Osicala", "Perquín", "San Carlos", "San Fernando", "San Isidro", "San Simón", "Sensembra", "Sociedad", "Torola", "Yamabal", "Yoloaiquín"],
      "San Miguel": ["San Miguel", "Carolina", "Chapeltique", "Chinameca", "Chirilagua", "Ciudad Barrios", "Comacarán", "El Tránsito", "Lolotique", "Moncagua", "Nueva Guadalupe", "Nuevo Edén de San Juan", "Quelepa", "San Antonio", "San Gerardo", "San Jorge", "San Luis de la Reina", "San Rafael Oriente", "Sesori", "Uluazapa"],
      "San Salvador": ["San Salvador", "Aguilares", "Apopa", "Ayutuxtepeque", "Cuscatancingo", "Delgado", "El Paisnal", "Guazapa", "Ilopango", "Mejicanos", "Nejapa", "Panchimalco", "Rosario de Mora", "San Marcos", "San Martín", "Santiago Texacuangos", "Santo Tomás", "Soyapango", "Tonacatepeque"],
      "San Vicente": ["San Vicente", "Apastepeque", "Guadalupe", "San Cayetano Istepeque", "San Esteban Catarina", "San Ildefonso", "San Lorenzo", "San Sebastián", "Santa Clara", "Santo Domingo", "Tecoluca", "Tepetitán", "Verapaz"],
      "Santa Ana": ["Santa Ana", "Candelaria de la Frontera", "Chalchuapa", "Coatepeque", "El Congo", "El Porvenir", "Masahuat", "Metapán", "San Antonio Pajonal", "San Sebastián Salitrillo", "Santa Rosa Guachipilín", "Santiago de la Frontera", "Texistepeque"],
      "Sonsonate": ["Sonsonate", "Acajutla", "Armenia", "Caluco", "Cuisnahuat", "Izalco", "Juayúa", "Nahuizalco", "Nahulingo", "Salcoatitán", "San Antonio del Monte", "San Julián", "Santa Catarina Masahuat", "Santa Isabel Ishuatán", "Santo Domingo de Guzmán", "Sonzacate"],
      "Usulután": ["Usulután", "Alegría", "Berlín", "California", "Concepción Batres", "El Triunfo", "Ereguayquín", "Estanzuelas", "Jiquilisco", "Jucuapa", "Jucuarán", "Mercedes Umaña", "Nueva Granada", "Ozatlán", "Puerto El Triunfo", "San Agustín", "San Buenaventura", "San Dionisio", "San Francisco Javier", "Santa Elena", "Santa María", "Santiago de María", "Tecapán"]
    };

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Cargar departamentos y municipios primero
        loadDepartamentos();
        
        // Verificar datos de checkout
        const checkoutData = await loadCheckoutData();
        if (!checkoutData) {
          showErrorAndRedirect('No se encontraron productos en el carrito');
          return;
        }

        // Mostrar productos en el resumen
        displayOrderItems(checkoutData.items);
        updateOrderTotals(checkoutData.total);
        updateCartCounter(checkoutData.items);
        
        // Verificar autenticación
        const user = await AuthService.checkAuth().catch(() => null);
        
        // Configurar campos según autenticación
        if (!user) {
          document.getElementById('guestNameField').classList.remove('guest-field');
          document.getElementById('customerName').required = true;
        } else {
          // Prellenar datos del usuario
          document.getElementById('customerEmail').value = user.email;
          document.getElementById('customerEmail').readOnly = true;
          
          try {
            const userProfile = await AuthService.getUserProfile(user.uid);
            if (userProfile) {
              if (userProfile.phone) {
                document.getElementById('customerPhone').value = userProfile.phone;
              }
              if (userProfile.address) {
                document.getElementById('shippingAddress').value = userProfile.address;
              }
            }
          } catch (error) {
            console.error("Error al obtener perfil:", error);
          }
        }

        // Configurar envío del formulario
        setupFormSubmission(user, checkoutData);

      } catch (error) {
        console.error("Error:", error);
        showErrorAndRedirect('Error al cargar la página de pago: ' + error.message);
      }
    });

    // Función para cargar departamentos y municipios
    function loadDepartamentos() {
      const deptoSelect = document.getElementById('departamento');
      const muniSelect = document.getElementById('municipio');
      
      // Limpiar y cargar departamentos
      deptoSelect.innerHTML = '<option value="">Seleccione un departamento</option>';
      Object.keys(departamentos).forEach(depto => {
        const option = document.createElement('option');
        option.value = depto;
        option.textContent = depto;
        deptoSelect.appendChild(option);
      });
      
      // Manejar cambio de departamento
      deptoSelect.addEventListener('change', function() {
        muniSelect.innerHTML = '<option value="">Seleccione un municipio</option>';
        muniSelect.disabled = !this.value;
        
        if (this.value) {
          departamentos[this.value].forEach(muni => {
            const option = document.createElement('option');
            option.value = muni;
            option.textContent = muni;
            muniSelect.appendChild(option);
          });
        }
      });
    }

    // Función para cargar datos del checkout
    async function loadCheckoutData() {
      // Intentar múltiples fuentes de datos
      const checkoutData = 
        JSON.parse(localStorage.getItem('currentCheckout')) || 
        JSON.parse(sessionStorage.getItem('checkoutData')) ||
        JSON.parse(localStorage.getItem('lastCheckoutBackup'));
      
      if (!checkoutData || !checkoutData.items || checkoutData.items.length === 0) {
        showEmptyCartMessage();
        return null;
      }
      
      return checkoutData;
    }

    // Función para mostrar productos en el resumen
    function displayOrderItems(items) {
      const orderItemsContainer = document.getElementById('orderItems');
      
      if (!items || items.length === 0) {
        orderItemsContainer.innerHTML = '<p class="error">No hay productos en el carrito</p>';
        return;
      }
      
      let html = '';
      items.forEach(item => {
        html += `
          <div class="order-item">
            <span>${item.name}</span>
            <span class="item-quantity">${item.quantity} ×</span>
            <span class="item-price">$${item.price.toFixed(2)}</span>
          </div>
        `;
      });
      
      orderItemsContainer.innerHTML = html;
    }

    // Función para actualizar totales
    function updateOrderTotals(total) {
      document.getElementById('orderTotal').textContent = total.toFixed(2);
      document.getElementById('paymentTotal').textContent = total.toFixed(2);
    }

    // Función para actualizar contador del carrito
    function updateCartCounter(items) {
      const counter = document.getElementById('cartCounter');
      if (counter) {
        const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
        counter.textContent = totalItems;
        counter.style.display = totalItems > 0 ? 'inline-block' : 'none';
      }
    }

    // Función para configurar el envío del formulario
    function setupFormSubmission(user, checkoutData) {
      document.getElementById('paymentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          // Mostrar carga
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<span class="loading"></span> Procesando...';
          submitBtn.disabled = true;
          
          // Validar y obtener datos del formulario
          const formData = validateFormData(user);
          
          // Crear y guardar la orden
          const orderId = await processOrder(user, checkoutData, formData);
          
          // Mostrar feedback
          showFeedback('¡Pago completado!', `Pedido #${orderId.substring(0, 8)} procesado`, 'success');
          
          // Limpiar y redirigir después de 3 segundos
          setTimeout(() => {
            clearCartAndRedirect(user, formData.customerEmail, orderId);
          }, 3000);
          
        } catch (error) {
          console.error("Error al procesar pago:", error);
          showFeedback('Error en el pago', error.message, 'error');
          
          // Restaurar botón
          const submitBtn = document.querySelector('#paymentForm button[type="submit"]');
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });
    }

    // Función para validar datos del formulario
    function validateFormData(user) {
      // Obtener datos básicos
      const customerName = !user ? document.getElementById('customerName').value.trim() : null;
      const customerEmail = document.getElementById('customerEmail').value.trim();
      const customerPhone = document.getElementById('customerPhone').value.trim();
      
      // Validar datos de contacto
      if (!customerEmail || !customerPhone || (!user && !customerName)) {
        throw new Error('Por favor complete todos los campos de contacto');
      }
      
      // Validar email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(customerEmail)) {
        throw new Error('Por favor ingrese un correo electrónico válido');
      }
      
      // Obtener y validar datos de envío
      const shippingAddress1 = document.getElementById('shippingAddress').value.trim();
      const departamento = document.getElementById('departamento').value;
      const municipio = document.getElementById('municipio').value;
      
      if (!shippingAddress1 || !departamento || !municipio) {
        throw new Error('Por favor complete todos los campos de dirección');
      }
      
      // Obtener y validar datos de pago
      const cardName = document.getElementById('cardName').value.trim();
      const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const expiryDate = document.getElementById('expiryDate').value.trim();
      const cvv = document.getElementById('cvv').value.trim();
      
      if (!cardName || !cardNumber || !expiryDate || !cvv) {
        throw new Error('Por favor complete todos los campos de pago');
      }
      
      // Validar tarjeta (simplificado)
      if (cardNumber.length < 13 || cardNumber.length > 19) {
        throw new Error('El número de tarjeta debe tener entre 13 y 19 dígitos');
      }
      
      // Validar fecha de expiración
      const [month, year] = expiryDate.split('/');
      if (!month || !year || month.length !== 2 || year.length !== 2) {
        throw new Error('Formato de fecha de expiración inválido (use MM/AA)');
      }
      
      return {
        customerName,
        customerEmail,
        customerPhone,
        shippingAddress1,
        shippingAddress2: document.getElementById('shippingAddress2').value.trim(),
        departamento,
        municipio,
        cardName,
        cardNumber,
        expiryDate,
        cvv
      };
    }

    // Función para procesar la orden
    async function processOrder(user, checkoutData, formData) {
      // Crear dirección completa
      const fullAddress = `${formData.shippingAddress1}${
        formData.shippingAddress2 ? ', ' + formData.shippingAddress2 : ''
      }, ${formData.municipio}, ${formData.departamento}`;
      
      // Crear objeto de orden
      const orderData = {
        userId: user ? user.uid : `guest_${Date.now()}`,
        items: checkoutData.items,
        subtotal: checkoutData.subtotal || checkoutData.total * 0.88,
        tax: checkoutData.tax || checkoutData.total * 0.12,
        total: checkoutData.total,
        customerInfo: {
          email: formData.customerEmail,
          phone: formData.customerPhone,
          ...(!user && { name: formData.customerName })
        },
        shippingInfo: {
          address: fullAddress,
          departamento: formData.departamento,
          municipio: formData.municipio
        },
        paymentInfo: {
          method: 'Tarjeta de crédito',
          cardLastFour: formData.cardNumber.slice(-4),
          cardType: detectCardType(formData.cardNumber)
        },
        status: 'Procesando',
        date: serverTimestamp()
      };
      
      // Guardar la orden en Firestore
      const orderRef = await addDoc(collection(db, 'orders'), orderData);
      
      // Actualizar perfil de usuario si está registrado
      if (user) {
        try {
          await updateDoc(doc(db, 'users', user.uid), {
            phone: orderData.customerInfo.phone,
            address: orderData.shippingInfo.address,
            lastUpdated: serverTimestamp()
          });
          
          // Limpiar carrito en Firestore
          await setDoc(doc(db, 'carts', user.uid), {
            items: [],
            lastUpdated: serverTimestamp()
          });
        } catch (error) {
          console.error("Error al actualizar perfil:", error);
        }
      }
      
      return orderRef.id;
    }

    // Función para detectar tipo de tarjeta (simplificado)
    function detectCardType(cardNumber) {
      const firstDigit = cardNumber.charAt(0);
      if (firstDigit === '4') return 'Visa';
      if (firstDigit === '5') return 'Mastercard';
      if (firstDigit === '3') return 'American Express';
      return 'Otra';
    }

    // Función para limpiar carrito y redirigir
    async function clearCartAndRedirect(user, email, orderId) {
      sessionStorage.setItem('clearCartOnLoad', 'true');
      localStorage.removeItem('cart');
      localStorage.removeItem('currentCheckout');
      localStorage.removeItem('lastCheckoutBackup');
      sessionStorage.removeItem('checkoutData');
      
      window.location.href = user ? 'perfil.html#compras' : 'index.html';
    }

    // Función para mostrar feedback
    function showFeedback(title, message, type = 'success') {
      const modal = document.getElementById('feedbackModal');
      const icon = document.getElementById('feedbackIcon');
      const feedbackTitle = document.getElementById('feedbackTitle');
      const feedbackMessage = document.getElementById('feedbackMessage');
      
      // Configurar contenido
      icon.innerHTML = `<i class="fas fa-${
        type === 'success' ? 'check-circle' : 
        type === 'error' ? 'times-circle' : 'exclamation-circle'
      } ${type}"></i>`;
      
      feedbackTitle.textContent = title;
      feedbackMessage.textContent = message;
      
      // Mostrar modal
      modal.classList.add('active');
      
      // Configurar cierre
      document.getElementById('feedbackClose').onclick = () => {
        modal.classList.remove('active');
      };
    }

    // Función para mostrar mensaje de carrito vacío
    function showEmptyCartMessage() {
      document.getElementById('orderItems').innerHTML = `
        <div class="error">
          <i class="fas fa-exclamation-triangle"></i>
          <p>No se encontraron productos. Redirigiendo...</p>
        </div>
      `;
      setTimeout(() => window.location.href = 'productos.html', 2000);
    }

    // Función para mostrar error y redirigir
    function showErrorAndRedirect(message) {
      showFeedback('Error', message, 'error');
      setTimeout(() => window.location.href = 'productos.html', 3000);
    }
  </script>
</body>
</html>
