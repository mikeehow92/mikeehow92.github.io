<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productos - TecnoExpress</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header>
    <!-- Encabezado se mantiene igual -->
  </header>

  <main class="container">
    <h1><i class="fas fa-print"></i> Nuestros Productos</h1>
    
    <div class="productos-grid">
      <!-- Producto 1 -->
      <div class="producto-card">
        <div class="producto-imagen">
          <img src="img/impresora1.webp" alt="Impresora Térmica EPSON">
        </div>
        <div class="producto-info">
          <h3>Impresora EPSON TM-T20III</h3>
          <div class="precio">$150.00</div>
          <button class="add-to-cart" 
                  data-id="prod001"
                  data-name="Impresora EPSON TM-T20III"
                  data-price="150.00"
                  data-image="img/impresora1.webp">
            <i class="fas fa-cart-plus"></i> Añadir al carrito
          </button>
        </div>
      </div>
      
      <!-- Producto 2 -->
      <div class="producto-card">
        <div class="producto-imagen">
          <img src="img/impresora2.webp" alt="Impresora Térmica EPSON">
        </div>
        <div class="producto-info">
          <h3>Impresora EPSON TM-T88III</h3>
          <div class="precio">$80.00</div>
          <button class="add-to-cart" 
                  data-id="prod002"
                  data-name="Impresora EPSON TM-T88III"
                  data-price="80.00"
                  data-image="img/impresora2.webp">
            <i class="fas fa-cart-plus"></i> Añadir al carrito
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal del Carrito -->
  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2><i class="fas fa-shopping-cart"></i> Tu Carrito</h2>
      <div id="cartItems">
        <div class="empty-cart">
          <i class="fas fa-shopping-cart"></i>
          <p>Tu carrito está vacío</p>
        </div>
      </div>
      <div class="cart-total">
        Total: $<span id="cartTotal">0.00</span>
      </div>
      <button class="checkout-btn" id="checkoutBtn">
        <i class="fas fa-credit-card"></i> Proceder al Pago
      </button>
    </div>
  </div>

  <!-- Scripts modificados -->
  <script type="module">
    // Importaciones esenciales
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
    
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCR-axayENUg4FFb4jj0uVW2BnfwQ5EiXY",
      authDomain: "mitienda-c2609.firebaseapp.com",
      projectId: "mitienda-c2609",
      storageBucket: "mitienda-c2609.appspot.com",
      messagingSenderId: "536746062790",
      appId: "1:536746062790:web:cd39eb0057aac14c6538c7"
    };

    // Inicialización
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Variables globales
    let cart = [];
    let currentUser = null;

    // Función para mostrar feedback
    function showFeedback(message, type = 'success') {
      const feedback = document.createElement('div');
      feedback.className = `feedback ${type}`;
      feedback.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(feedback);
      setTimeout(() => feedback.remove(), 3000);
    }

    // Función para añadir al carrito (ahora es global)
    window.addToCart = function(product) {
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({
          id: product.id,
          name: product.name,
          price: product.price,
          quantity: 1,
          image: product.image || ''
        });
      }
      updateCart();
      showFeedback(`${product.name} añadido al carrito`, 'success');
    };

    // Función para actualizar el carrito
    async function updateCart() {
      // Guardar en Firestore o localStorage
      try {
        if (currentUser) {
          await setDoc(doc(db, 'carts', currentUser.uid), {
            items: cart,
            lastUpdated: serverTimestamp()
          });
        } else {
          localStorage.setItem('cart', JSON.stringify(cart));
        }
      } catch (error) {
        console.error("Error al guardar el carrito:", error);
      }
      
      // Actualizar UI
      updateCartUI();
    }

    // Función para actualizar la interfaz
    function updateCartUI() {
      const cartItems = document.getElementById('cartItems');
      const cartTotal = document.getElementById('cartTotal');
      
      if (cartItems) {
        cartItems.innerHTML = cart.length > 0 ? '' : `
          <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <p>Tu carrito está vacío</p>
          </div>
        `;

        let total = 0;
        cart.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'cart-item';
          itemElement.innerHTML = `
            <div class="cart-item-info">
              <span class="cart-item-name">${item.name}</span>
              <div class="cart-item-controls">
                <button class="quantity-btn minus" data-id="${item.id}">-</button>
                <span class="item-quantity">${item.quantity}</span>
                <button class="quantity-btn plus" data-id="${item.id}">+</button>
              </div>
              <span class="cart-item-price">$${(item.price * item.quantity).toFixed(2)}</span>
            </div>
            <button class="remove-item" data-id="${item.id}">
              <i class="fas fa-trash"></i>
            </button>
          `;
          cartItems.appendChild(itemElement);
          total += item.price * item.quantity;
        });

        if (cartTotal) cartTotal.textContent = total.toFixed(2);
      }
      updateCartCounter();
    }

    // Función para actualizar el contador
    function updateCartCounter() {
      const counter = document.getElementById('cartCounter');
      if (counter) {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        counter.textContent = totalItems;
        counter.style.display = totalItems > 0 ? 'inline-block' : 'none';
      }
    }

    // Cargar carrito al iniciar
    async function loadCart() {
      try {
        if (currentUser) {
          const docSnap = await getDoc(doc(db, 'carts', currentUser.uid));
          if (docSnap.exists()) {
            cart = docSnap.data().items || [];
          }
        } else {
          const localCart = localStorage.getItem('cart');
          if (localCart) cart = JSON.parse(localCart);
        }
        updateCartUI();
      } catch (error) {
        console.error("Error al cargar el carrito:", error);
      }
    }

    // Observador de autenticación
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      loadCart();
    });

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Delegación de eventos para botones
      document.addEventListener('click', (e) => {
        // Añadir al carrito
        if (e.target.closest('.add-to-cart')) {
          const button = e.target.closest('.add-to-cart');
          const product = {
            id: button.dataset.id,
            name: button.dataset.name,
            price: parseFloat(button.dataset.price),
            image: button.dataset.image || ''
          };
          addToCart(product);
        }
        
        // Eliminar producto
        if (e.target.closest('.remove-item')) {
          const productId = e.target.closest('.remove-item').dataset.id;
          cart = cart.filter(item => item.id !== productId);
          updateCart();
        }
        
        // Modificar cantidad
        if (e.target.closest('.quantity-btn')) {
          const btn = e.target.closest('.quantity-btn');
          const item = cart.find(item => item.id === btn.dataset.id);
          if (item) {
            const newQuantity = btn.classList.contains('plus') 
              ? item.quantity + 1 
              : item.quantity - 1;
            item.quantity = Math.max(1, newQuantity);
            updateCart();
          }
        }
        
        // Checkout
        if (e.target.closest('#checkoutBtn')) {
          e.preventDefault();
          // Lógica de checkout aquí
          alert('Redirigiendo al pago');
        }
      });

      // Modal del carrito
      const cartModal = document.getElementById('cartModal');
      if (cartModal) {
        document.getElementById('cartIcon')?.addEventListener('click', () => {
          cartModal.classList.add('active');
        });

        document.querySelector('.close-modal')?.addEventListener('click', () => {
          cartModal.classList.remove('active');
        });

        cartModal.addEventListener('click', (e) => {
          if (e.target === cartModal) {
            cartModal.classList.remove('active');
          }
        });
      }
    });
  </script>
</body>
</html>
