<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productos - TecnoExpress</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header>
    <div class="container header-container">
      <div class="logo">
        <a href="index.html"><img src="img/logo.png" alt="TecnoExpress"></a>
      </div>
      <nav>
        <ul>
          <li><a href="index.html"><i class="fas fa-home"></i> Inicio</a></li>
          <li><a href="productos.html" class="active"><i class="fas fa-print"></i> Productos</a></li>
          <li><a href="#"><i class="fas fa-envelope"></i> Contacto</a></li>
        </ul>
      </nav>
      <div class="cart-icon" id="cartIcon">
        <i class="fas fa-shopping-cart"></i>
        <span id="cartCounter">0</span>
      </div>
    </div>
  </header>

  <main class="container">
    <h1><i class="fas fa-print"></i> Nuestros Productos</h1>
    
    <div class="productos-grid">
      <div class="producto-card">
        <div class="producto-imagen">
          <img src="img/impresora1.webp" alt="Impresora T√©rmica EPSON">
        </div>
        <div class="producto-info">
          <h3>Impresora EPSON TM-T20III</h3>
          <div class="precio">$150.00</div>
          <button class="add-to-cart" 
                  data-id="prod001"
                  data-name="Impresora EPSON TM-T20III"
                  data-price="150.00"
                  data-image="img/impresora1.webp">
            <i class="fas fa-cart-plus"></i> A√±adir al carrito
          </button>
        </div>
      </div>
      
      <div class="producto-card">
        <div class="producto-imagen">
          <img src="img/impresora2.webp" alt="Impresora T√©rmica EPSON">
        </div>
        <div class="producto-info">
          <h3>Impresora EPSON TM-T88III</h3>
          <div class="precio">$80.00</div>
          <button class="add-to-cart" 
                  data-id="prod002"
                  data-name="Impresora EPSON TM-T88III"
                  data-price="80.00"
                  data-image="img/impresora2.webp">
            <i class="fas fa-cart-plus"></i> A√±adir al carrito
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal del Carrito -->
  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2><i class="fas fa-shopping-cart"></i> Tu Carrito</h2>
      <div id="cartItems">
        <div class="empty-cart">
          <i class="fas fa-shopping-cart"></i>
          <p>Tu carrito est√° vac√≠o</p>
        </div>
      </div>
      <div class="cart-total">
        Total: $<span id="cartTotal">0.00</span>
      </div>
      <button class="checkout-btn" id="checkoutBtn">
        <i class="fas fa-credit-card"></i> Proceder al Pago
      </button>
    </div>
  </div>

  <script type="module">
    // Importar la configuraci√≥n centralizada de Firebase
    import { app, db, auth } from '/js/firebase-config.js';
    import { 
      doc, setDoc, getDoc, serverTimestamp,
      collection, addDoc
    } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
    import { 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
    
    // Variables globales
    let cart = [];
    let currentUser = null;

    // Observador de autenticaci√≥n
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      loadCart();
    });

    // Funciones del carrito
    async function loadCart() {
      try {
        const shouldClearCart = sessionStorage.getItem('clearCartOnLoad');
        
        if (shouldClearCart) {
          cart = [];
          localStorage.removeItem('cart');
          sessionStorage.removeItem('clearCartOnLoad');
          
          if (currentUser) {
            await setDoc(doc(db, 'carts', currentUser.uid), {
              items: [],
              lastUpdated: serverTimestamp()
            });
          }
          
          updateCartUI();
          return;
        }

        const localCart = localStorage.getItem('cart');
        if (localCart) {
          cart = JSON.parse(localCart);
        }
        
        if (currentUser) {
          const docSnap = await getDoc(doc(db, 'carts', currentUser.uid));
          if (docSnap.exists()) {
            cart = docSnap.data().items || [];
            localStorage.setItem('cart', JSON.stringify(cart));
          }
        }
        
        updateCartUI();
      } catch (error) {
        console.error("Error al cargar el carrito:", error);
        showFeedback('Error al cargar el carrito', 'error');
      }
    }

    function updateCartUI() {
      const cartItems = document.getElementById('cartItems');
      const cartTotal = document.getElementById('cartTotal');
      
      if (cartItems) {
        cartItems.innerHTML = cart.length > 0 ? '' : `
          <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <p>Tu carrito est√° vac√≠o</p>
          </div>
        `;

        let total = 0;
        cart.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'cart-item';
          itemElement.innerHTML = `
            <div class="cart-item-info">
              <span class="cart-item-name">${item.name}</span>
              <div class="cart-item-controls">
                <button class="quantity-btn minus" data-id="${item.id}">-</button>
                <span class="item-quantity">${item.quantity}</span>
                <button class="quantity-btn plus" data-id="${item.id}">+</button>
              </div>
              <span class="cart-item-price">$${(item.price * item.quantity).toFixed(2)}</span>
            </div>
            <button class="remove-item" data-id="${item.id}">
              <i class="fas fa-trash"></i>
            </button>
          `;
          cartItems.appendChild(itemElement);
          total += item.price * item.quantity;
        });

        if (cartTotal) cartTotal.textContent = total.toFixed(2);
      }
      updateCartCounter();
    }

    function updateCartCounter() {
      const counter = document.getElementById('cartCounter');
      if (counter) {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        counter.textContent = totalItems;
        counter.style.display = totalItems > 0 ? 'inline-block' : 'none';
      }
    }

    async function saveCartToFirestore() {
      try {
        if (!currentUser) {
          localStorage.setItem('cart', JSON.stringify(cart));
          return;
        }

        await setDoc(doc(db, 'carts', currentUser.uid), {
          items: cart,
          lastUpdated: serverTimestamp()
        }, { merge: true });
      } catch (error) {
        console.error("Error al guardar en Firestore:", error);
        localStorage.setItem('cart', JSON.stringify(cart));
      }
    }

    function addToCart(product) {
      const existingItem = cart.find(item => item.id === product.id);
      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({
          id: product.id,
          name: product.name,
          price: product.price,
          quantity: 1,
          image: product.image || ''
        });
      }
      
      saveCartToFirestore();
      updateCartUI();
      
      // Feedback visual
      const feedback = document.createElement('div');
      feedback.className = 'cart-feedback show';
      feedback.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>${product.name} a√±adido al carrito</span>
      `;
      document.body.appendChild(feedback);
      setTimeout(() => {
        feedback.classList.remove('show');
        setTimeout(() => feedback.remove(), 300);
      }, 2000);
    }

    function removeFromCart(productId) {
      cart = cart.filter(item => item.id !== productId);
      saveCartToFirestore();
      updateCartUI();
    }

    function updateQuantity(productId, newQuantity) {
      const item = cart.find(item => item.id === productId);
      if (item) {
        item.quantity = Math.max(1, newQuantity);
        saveCartToFirestore();
        updateCartUI();
      }
    }

    async function proceedToCheckout() {
      if (cart.length === 0) {
        showFeedback('üõí Tu carrito est√° vac√≠o', 'error');
        return false;
      }

      try {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const tax = parseFloat((subtotal * 0.12).toFixed(2));
        const total = parseFloat((subtotal + tax).toFixed(2));

        const checkoutData = {
          items: cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            image: item.image || 'img/default-product.webp'
          })),
          subtotal: subtotal,
          tax: tax,
          total: total,
          userId: currentUser ? currentUser.uid : `guest_${Date.now()}`,
          userEmail: currentUser ? currentUser.email : null,
          isGuest: !currentUser,
          createdAt: new Date().toISOString(),
          timestamp: new Date().getTime()
        };

        localStorage.setItem('currentCheckout', JSON.stringify(checkoutData));
        sessionStorage.setItem('checkoutData', JSON.stringify(checkoutData));
        localStorage.setItem('lastCheckoutBackup', JSON.stringify(checkoutData));

        if (currentUser) {
          await addDoc(collection(db, 'checkouts'), {
            ...checkoutData,
            status: 'pending',
            createdAt: serverTimestamp()
          });
        }

        window.location.href = 'pago.html';
        return true;
      } catch (error) {
        console.error('Error en checkout:', error);
        showFeedback('Error al procesar tu pedido: ' + error.message, 'error');
        return false;
      }
    }

    function showFeedback(message, type = 'success') {
      const feedback = document.createElement('div');
      feedback.className = `feedback ${type}`;
      feedback.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(feedback);
      setTimeout(() => {
        feedback.classList.add('hide');
        setTimeout(() => feedback.remove(), 300);
      }, 3000);
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadCart();

      // Delegaci√≥n de eventos
      document.addEventListener('click', function(e) {
        if (e.target.closest('.add-to-cart')) {
          const button = e.target.closest('.add-to-cart');
          const product = {
            id: button.dataset.id,
            name: button.dataset.name,
            price: parseFloat(button.dataset.price),
            image: button.dataset.image || ''
          };
          addToCart(product);
        }
        
        if (e.target.closest('.remove-item')) {
          const productId = e.target.closest('.remove-item').dataset.id;
          removeFromCart(productId);
        }
        
        if (e.target.closest('.quantity-btn.plus')) {
          const productId = e.target.closest('.quantity-btn').dataset.id;
          const item = cart.find(item => item.id === productId);
          if (item) updateQuantity(productId, item.quantity + 1);
        }
        
        if (e.target.closest('.quantity-btn.minus')) {
          const productId = e.target.closest('.quantity-btn').dataset.id;
          const item = cart.find(item => item.id === productId);
          if (item) updateQuantity(productId, item.quantity - 1);
        }
        
        if (e.target.closest('#checkoutBtn')) {
          e.preventDefault();
          proceedToCheckout();
        }
      });

      // Modal del carrito
      const cartModal = document.getElementById('cartModal');
      if (cartModal) {
        document.getElementById('cartIcon')?.addEventListener('click', () => {
          cartModal.classList.add('active');
          document.body.style.overflow = 'hidden';
        });

        document.querySelector('.close-modal')?.addEventListener('click', () => {
          cartModal.classList.remove('active');
          document.body.style.overflow = '';
        });

        cartModal.addEventListener('click', (e) => {
          if (e.target === cartModal) {
            cartModal.classList.remove('active');
            document.body.style.overflow = '';
          }
        });
      }
    });
  </script>
</body>
</html>
