import{initializeApp as j}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getFirestore as q,collection as O,query as T,limit as k,getDocs as K}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";import{getAuth as M,onAuthStateChanged as P,signOut as R}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getStorage as z,ref as F,getDownloadURL as x}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}})();function m(e,o="info"){const a=document.createElement("div");a.className="fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-50",o==="info"?a.classList.add("bg-blue-500"):o==="success"?a.classList.add("bg-green-500"):o==="error"&&a.classList.add("bg-red-500"),a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.remove()},3e3)}window.alert=m;function f(){const e=localStorage.getItem("shoppingCart");return e?JSON.parse(e):[]}function E(e){localStorage.setItem("shoppingCart",JSON.stringify(e)),typeof window.updateCartDisplay=="function"?window.updateCartDisplay():console.warn("window.updateCartDisplay no está definida. La UI del carrito no se actualizará.")}function J(e){let o=f();const a=o.findIndex(n=>n.id===e.id);a>-1?o[a].quantity+=e.quantity||1:o.push({...e,quantity:e.quantity||1}),E(o),m(`"${e.name}" añadido al carrito.`,"success")}function A(e){let o=f();o=o.filter(a=>a.id!==e),E(o),m("Producto eliminado del carrito.","info")}function Q(e,o){let a=f();const n=a.find(r=>r.id===e);n&&(n.quantity=o,n.quantity<=0?A(e):E(a))}function V(){return f().reduce((e,o)=>e+o.price*o.quantity,0)}const G="AVQpOYnmo31PwFuK1rNOHJN-zp6cHl1BdMkac2K0PhJ2ucmHSosW8iKg4fWHiF817wVu6y9jcAL9ibFd";function W(){if(document.getElementById("paypal-sdk"))return;const e=document.createElement("script");e.src=`https://www.paypal.com/sdk/js?client-id=${G}&currency=USD`,e.id="paypal-sdk",e.onload=()=>{console.log("SDK de PayPal cargado."),document.dispatchEvent(new CustomEvent("paypalSDKLoaded"))},e.onerror=()=>{console.error("Error al cargar el SDK de PayPal."),m("Error al cargar PayPal. Por favor, inténtalo de nuevo más tarde.","error")},document.head.appendChild(e)}window.getCart=f;window.addToCart=J;window.removeFromCart=A;window.updateCartItemQuantity=Q;window.getCartTotal=V;window.loadPayPalSDK=W;window.showAlert=m;const Y={apiKey:"AIzaSyCR-axayENUg4FFb4jj0uVW2BnfwQ5EiXY",authDomain:"mitienda-c2609.firebaseapp.com",databaseURL:"https://mitienda-c2609-default-rtdb.firebaseio.com",projectId:"mitienda-c2609",storageBucket:"mitienda-c2609.firebasestorage.app",messagingSenderId:"536746062790",appId:"1:536746062790:web:6e545efbc8f037e36538c7"},C=j(Y),_=q(C),D=M(C);window.firebaseApp=C;window.firebaseDb=_;window.firebaseAuth=D;P(D,e=>{e?console.log("Usuario autenticado globalmente:",e.uid):console.log("Usuario no autenticado globalmente.")});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loginButton");console.log("Elemento del botón de Iniciar Sesión:",e);const o=document.getElementById("loggedInUserDisplay"),a=document.getElementById("userNameDisplay"),n=document.getElementById("profileAvatarHeader"),r=document.getElementById("logoutButton"),s=document.getElementById("navCarrito"),l=document.getElementById("profileLinkHeader"),g=document.getElementById("cartItemCount"),w=window.firebaseAuth,I=window.firebaseApp,b=I?z(I):null;function B(){const c=window.getCart().reduce((d,u)=>d+u.quantity,0);g&&(g.textContent=c,c>0?g.classList.remove("hidden"):g.classList.add("hidden")),s&&s.classList.remove("hidden")}window.updateCartDisplay=function(){B()},w?P(w,async i=>{if(i){if(e.classList.add("hidden"),o.classList.remove("hidden"),a.textContent=i.displayName||i.email||"Tu Usuario",l&&l.classList.remove("hidden"),n)if(i.photoURL)n.src=i.photoURL;else if(b)try{const c=F(b,`avatars/${i.uid}.png`),d=await x(c);n.src=d}catch(c){try{const d=F(b,`avatars/${i.uid}.jpg`),u=await x(d);n.src=u}catch(d){console.warn(`No se encontró avatar por UID para ${i.uid} (.png o .jpg) en el header. Usando placeholder.`,c.code,d.code),n.src="https://placehold.co/40x40/F0F0F0/333333?text=A"}}else n.src="https://placehold.co/40x40/F0F0F0/333333?text=A"}else e.classList.remove("hidden"),o.classList.add("hidden"),l&&l.classList.add("hidden"),n&&(n.src="https://placehold.co/40x40/F0F0F0/333333?text=A");window.updateCartDisplay()}):(console.warn("Firebase Auth no está inicializado. La funcionalidad de autenticación no estará disponible."),l&&l.classList.add("hidden"),n&&(n.src="https://placehold.co/40x40/F0F0F0/333333?text=A"),window.updateCartDisplay()),e&&e.addEventListener("click",()=>{console.log('Botón "Iniciar Sesión" clickeado. Redirigiendo a login.html...'),window.location.href="login.html"}),r&&r.addEventListener("click",async()=>{if(w)try{await R(w),window.showAlert("Has cerrado sesión correctamente.","success")}catch(i){console.error("Error al cerrar sesión:",i.message),window.showAlert("Error al cerrar sesión. Por favor, inténtalo de nuevo.","error")}else window.showAlert("Firebase Auth no está disponible para cerrar sesión.","error")});const L=document.querySelector('#nosotros a[href="#contacto"]');L&&L.addEventListener("click",i=>{i.preventDefault(),console.log('Botón "Contáctanos" clickeado.'),document.getElementById("contacto").scrollIntoView({behavior:"smooth"})});const v=document.getElementById("contactForm");v&&v.addEventListener("submit",async i=>{i.preventDefault();const c=document.getElementById("fullName").value,d=document.getElementById("email").value,u=document.getElementById("message").value;console.log("Formulario de Contacto Enviado:"),console.log("Nombre Completo:",c),console.log("Correo Electrónico:",d),console.log("Mensaje:",u);const y="https://us-central1-mitienda-c2609.cloudfunctions.net/api";try{const t=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fullName:c,email:d,message:u})});if(t.ok)window.showAlert("¡Mensaje enviado con éxito! Nos pondremos en contacto pronto.","success"),v.reset();else{const p=await t.json();window.showAlert(`Error al enviar mensaje: ${p.message||"Error desconocido"}`,"error"),console.error("Error al enviar el formulario:",p)}}catch(t){console.error("Error de red o del servidor al enviar el formulario:",t),window.showAlert("Hubo un error de red o del servidor. Por favor, inténtalo más tarde.","error")}});const h=document.getElementById("productGridHome");async function N(){h.innerHTML="";const i=window.firebaseDb;if(!i){console.error("Firebase Firestore no está inicializado. No se pueden cargar los productos."),window.showAlert("Error: No se pudo conectar con la base de datos de productos. Asegúrate de configurar Firebase en common.js.","error");return}try{const c=O(i,"productos"),d=T(c,k(6)),y=(await K(d)).docs.map(t=>({id:t.id,...t.data()}));if(y.length===0){h.innerHTML='<p class="text-gray-600 text-center col-span-full">No hay productos disponibles en este momento en Firestore.</p>';return}y.forEach(t=>{console.log(`Producto: ${t.nombre}, URL de Imagen: ${t.imagenUrl}`);const p=`
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition duration-300">
                        <a href="detalle-producto.html?id=${t.id}" class="block">
                            <img src="${t.imagenUrl||"https://placehold.co/400x300/F0F0F0/333333?text=No+Image"}"
                                 alt="${t.nombre||"Producto sin nombre"}"
                                 class="w-full h-48 object-contain">
                            <div class="p-6">
                                <h3 class="text-xl font-semibold text-gray-900 mb-2">${t.nombre||"Producto sin nombre"}</h3>
                                <p class="text-gray-700 mb-4">${t.descripcion||"Sin descripción."}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-2xl font-bold text-dark-blue">$${(t.precio||0).toFixed(2)}</span>
                                    <button class="add-to-cart-btn bg-dark-blue hover:bg-blue-800 text-white py-2 px-4 rounded-full text-sm font-semibold transition duration-300"
                                            data-product-id="${t.id}"
                                            data-product-name="${t.nombre||"Producto sin nombre"}"
                                            data-product-price="${t.precio||0}"
                                            data-product-image="${t.imagenUrl||""}">
                                        Añadir al Carrito
                                    </button>
                                </div>
                            </div>
                        </a>
                    </div>
                `;h.innerHTML+=p}),document.querySelectorAll("#productGridHome .add-to-cart-btn").forEach(t=>{t.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation();const S=t.dataset.productId,U=t.dataset.productName,$=parseFloat(t.dataset.productPrice),H=t.dataset.productImage;window.addToCart({id:S,name:U,price:$,imageUrl:H,quantity:1})})})}catch(c){console.error("Error al cargar los productos para la página de inicio desde Firestore:",c),h.innerHTML='<p class="text-red-500 text-center col-span-full">Error al cargar los productos. Por favor, verifica tu conexión a Firestore y las reglas de seguridad.</p>'}}N()});
